#
# $Id$
#
Summary: Calpont InfiniDB community software
Name: calpont
@@VERSION@@
@@RELEASE@@
Vendor: Calpont Corp.
URL: http://www.calpont.com/
@@PACKAGER@@
Group: Applications
License: GPL
BuildRoot: %{_tmppath}/%{name}-%{release}-buildroot
%ifarch x86_64
Provides: libconfigcpp.so()(64bit), libddlpackage.so()(64bit), libddlpackageproc.so()(64bit), libdmlpackage.so()(64bit), libdmlpackageproc.so()(64bit), libexecplan.so()(64bit), libloggingcpp.so()(64bit), libmessageqcpp.so()(64bit), liboamcpp.so()(64bit), libsnmpmanager.so()(64bit), libthreadpool.so()(64bit), libwriteengine.so()(64bit), libbrm.so()(64bit), librwlock.so()(64bit), libfuncexp.so()(64bit), libjoblist.so()(64bit), libdm.so()(64bit), libdataconvert.so()(64bit), libsm.so()(64bit), libjoiner.so()(64bit), librowgroup.so()(64bit), libcacheutils.so()(64bit), libreplaytxnlog.so()(64bit), libmulticast.so()(64bit), libcommon.so()(64bit), libboost_idb.so()(64bit)
%else
Provides: libconfigcpp.so, libddlpackage.so, libddlpackageproc.so, libdmlpackage.so, libdmlpackageproc.so, libexecplan.so, libloggingcpp.so, libmessageqcpp.so, liboamcpp.so, libsnmpmanager.so, libthreadpool.so, libwriteengine.so, libbrm.so, librwlock.so, libfuncexp.so, libjoblist.so, libdm.so, libdataconvert.so, libsm.so, libjoiner.so, librowgroup.so, libcacheutils.so, libreplaytxnlog.so, libmulticast.so, libcommon.so, libboost_idb.so
%endif

%description
Copyright (c) 2011 Calpont Corp., all rights reserved
Calpont InfiniDB community binary files
@@BUILDINFO@@

%package mysql
Summary: Calpont InfiniDB community software MySQL connector
Group: Applications
Requires: calpont = %{version}, calpont-mysqld >= 1.1
%ifarch x86_64
Provides: libcalmysql.so()(64bit)
%else
Provides: libcalmysql.so
%endif

%description mysql
Calpont InfiniDB community MySQL connector binary files

%package mysqld
Summary: Calpont InfiniDB community software MySQL server
Group: Applications

%description mysqld
Calpont InfiniDB community MySQL 5.1.39 server binary files

%prep

%build

%install
mkdir -p %{buildroot}/usr/local
tar -C $RPM_BUILD_DIR/%{name}-%{version}-%{release} -cf - . | tar -C %{buildroot}/usr/local -xf -

%clean
rm -rf $RPM_BUILD_ROOT $RPM_BUILD_DIR/%{name}-%{version}-%{release}

%changelog

%files
%defattr(-, root, root)

/usr/local/Calpont/COPYING
/usr/local/Calpont/README
/usr/local/Calpont/INSTALL
/usr/local/Calpont/releasenum

/usr/local/Calpont/local/module

/usr/local/Calpont/bin/DDLProc
/usr/local/Calpont/bin/ExeMgr
/usr/local/Calpont/bin/DMLProc
/usr/local/Calpont/bin/post-install
/usr/local/Calpont/bin/post-mysql-install
/usr/local/Calpont/bin/post-mysqld-install
/usr/local/Calpont/bin/pre-uninstall
/usr/local/Calpont/bin/PrimProc
/usr/local/Calpont/bin/DecomSvr
/usr/local/Calpont/bin/calpontLogRotate
/usr/local/Calpont/bin/transactionLog
/usr/local/Calpont/bin/ReplayTransactionLog
/usr/local/Calpont/bin/transactionLogArchiver.sh
/usr/local/Calpont/bin/startupTests.sh
/usr/local/Calpont/bin/run.sh
/usr/local/Calpont/bin/upgrade-infinidb.sh
/usr/local/Calpont/bin/os_check.sh
# Tools...
/usr/local/Calpont/bin/dbbuilder
/usr/local/Calpont/bin/dumpcol
/usr/local/Calpont/bin/oid2file
/usr/local/Calpont/bin/editem
/usr/local/Calpont/bin/evalcol
/usr/local/Calpont/bin/cpimport
/usr/local/Calpont/bin/load_brm
/usr/local/Calpont/bin/save_brm
/usr/local/Calpont/bin/dbrmctl
/usr/local/Calpont/bin/controllernode
/usr/local/Calpont/bin/reset_locks
/usr/local/Calpont/bin/rollback
/usr/local/Calpont/bin/workernode
/usr/local/Calpont/bin/colxml
/usr/local/Calpont/bin/getConfig
/usr/local/Calpont/bin/SesMgr
/usr/local/Calpont/bin/dumpVss
/usr/local/Calpont/bin/editTxn
/usr/local/Calpont/bin/dumpobm
/usr/local/Calpont/bin/file2oid.pl
/usr/local/Calpont/bin/cplogger
/usr/local/Calpont/bin/clearShm
/usr/local/Calpont/bin/setConfig
/usr/local/Calpont/bin/configxml.sh
/usr/local/Calpont/bin/infinidb
/usr/local/Calpont/bin/install-infinidb.sh
/usr/local/Calpont/bin/calpontAlias
/usr/local/Calpont/bin/viewtablelock
/usr/local/Calpont/bin/cleartablelock
/usr/local/Calpont/bin/ddlcleanup
/usr/local/Calpont/bin/idbmeminfo
/usr/local/Calpont/bin/print_journal
#
%config /usr/local/Calpont/etc/Calpont.xml
%config /usr/local/Calpont/etc/ConsoleCmds.xml
%config /usr/local/Calpont/etc/ProcessConfig.xml
%config /usr/local/Calpont/etc/Calpont.xml.singleserver
%config /usr/local/Calpont/etc/ProcessConfig.xml.singleserver
#
/usr/local/Calpont/etc/MessageFile.txt
/usr/local/Calpont/etc/ErrorMessage.txt
#
%config %attr(0666, root, root) /usr/local/Calpont/etc/AlarmConfig.xml
#
/usr/local/Calpont/lib/libconfigcpp.so.1.0.0
/usr/local/Calpont/lib/libddlpackageproc.so.1.0.0
/usr/local/Calpont/lib/libddlpackage.so.1.0.0
/usr/local/Calpont/lib/libdmlpackageproc.so.1.0.0
/usr/local/Calpont/lib/libdmlpackage.so.1.0.0
/usr/local/Calpont/lib/libexecplan.so.1.0.0
/usr/local/Calpont/lib/libfuncexp.so.1.0.0
/usr/local/Calpont/lib/libjoblist.so.1.0.0
/usr/local/Calpont/lib/libjoiner.so.1.0.0
/usr/local/Calpont/lib/libloggingcpp.so.1.0.0
/usr/local/Calpont/lib/libmessageqcpp.so.1.0.0
/usr/local/Calpont/lib/liboamcpp.so.1.0.0
/usr/local/Calpont/lib/libreplaytxnlog.so.1.0.0
/usr/local/Calpont/lib/libsnmpmanager.so.1.0.0
/usr/local/Calpont/lib/libthreadpool.so.1.0.0
/usr/local/Calpont/lib/libwriteengine.so.1.0.0
/usr/local/Calpont/lib/libsm.so.1.0.0
/usr/local/Calpont/lib/libbrm.so.1.0.0
/usr/local/Calpont/lib/librwlock.so.1.0.0
/usr/local/Calpont/lib/libdm.so.1.0.0
/usr/local/Calpont/lib/libdataconvert.so.1.0.0
/usr/local/Calpont/lib/librowgroup.so.1.0.0
/usr/local/Calpont/lib/libcacheutils.so.1.0.0
/usr/local/Calpont/lib/libmulticast.so.1.0.0
/usr/local/Calpont/lib/libcommon.so.1.0.0
/usr/local/Calpont/lib/libboost_idb.so.1.0.0
#
#
/usr/local/Calpont/post/functions
/usr/local/Calpont/post/test-001.sh
/usr/local/Calpont/post/test-002.sh
/usr/local/Calpont/post/test-003.sh
/usr/local/Calpont/post/test-004.sh
#
%files mysql
/usr/local/Calpont/lib/libcalmysql.so.1.0.0
#
%files mysqld
/usr/local/Calpont/mysql/lib/mysql/libmysqlclient.so.16.0.0
/usr/local/Calpont/mysql/lib/mysql/libmysqlclient_r.so.16.0.0
/usr/local/Calpont/mysql/lib/mysql/plugin/ha_federated.so.0.0.0
/usr/local/Calpont/mysql/lib/mysql/plugin/ha_blackhole.so.0.0.0
/usr/local/Calpont/mysql/lib/mysql/plugin/ha_archive.so.0.0.0
/usr/local/Calpont/mysql/lib/mysql/plugin/ha_innodb.so.0.0.0
/usr/local/Calpont/mysql/lib/mysql/plugin/ha_innodb_plugin.so.0.0.0
/usr/local/Calpont/mysql/libexec/mysqlmanager
/usr/local/Calpont/mysql/libexec/mysqld
/usr/local/Calpont/mysql/bin/mysql_find_rows
/usr/local/Calpont/mysql/bin/mysqlbug
/usr/local/Calpont/mysql/bin/innochecksum
/usr/local/Calpont/mysql/bin/mysql_secure_installation
/usr/local/Calpont/mysql/bin/resolve_stack_dump
/usr/local/Calpont/mysql/bin/my_print_defaults
/usr/local/Calpont/mysql/bin/mysql_waitpid
/usr/local/Calpont/mysql/bin/resolveip
/usr/local/Calpont/mysql/bin/perror
/usr/local/Calpont/mysql/bin/myisamlog
/usr/local/Calpont/mysql/bin/mysql
/usr/local/Calpont/mysql/bin/myisamchk
/usr/local/Calpont/mysql/bin/mysql_fix_privilege_tables
/usr/local/Calpont/mysql/bin/mysql_upgrade
/usr/local/Calpont/mysql/bin/mysqlcheck
/usr/local/Calpont/mysql/bin/myisampack
/usr/local/Calpont/mysql/bin/mysql_setpermission
/usr/local/Calpont/mysql/bin/mysqladmin
/usr/local/Calpont/mysql/bin/mysqlslap
/usr/local/Calpont/mysql/bin/mysql_zap
/usr/local/Calpont/mysql/bin/mysqldump
/usr/local/Calpont/mysql/bin/mysqld_safe
/usr/local/Calpont/mysql/bin/mysqlshow
/usr/local/Calpont/mysql/bin/mysqltest
/usr/local/Calpont/mysql/bin/mysql_config
/usr/local/Calpont/mysql/bin/mysql_client_test
/usr/local/Calpont/mysql/bin/mysqlbinlog
/usr/local/Calpont/mysql/bin/mysqld_multi
/usr/local/Calpont/mysql/bin/mysqlaccess
/usr/local/Calpont/mysql/bin/mysql_install_db
/usr/local/Calpont/mysql/bin/msql2mysql
/usr/local/Calpont/mysql/bin/mysqlimport
/usr/local/Calpont/mysql/bin/replace
/usr/local/Calpont/mysql/bin/mysql_convert_table_format
/usr/local/Calpont/mysql/bin/myisam_ftdump
/usr/local/Calpont/mysql/bin/mysql_tzinfo_to_sql
/usr/local/Calpont/mysql/bin/mysql_fix_extensions
/usr/local/Calpont/mysql/bin/mysqldumpslow
/usr/local/Calpont/mysql/bin/mysqlhotcopy
/usr/local/Calpont/mysql/share/mysql/config.small.ini
/usr/local/Calpont/mysql/share/mysql/romanian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/korean/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/norwegian-ny/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/binary-configure
/usr/local/Calpont/mysql/share/mysql/french/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/greek/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mysql-log-rotate
/usr/local/Calpont/mysql/share/mysql/mysql_system_tables_data.sql
/usr/local/Calpont/mysql/share/mysql/russian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mysql.server
/usr/local/Calpont/mysql/share/mysql/mi_test_all.res
/usr/local/Calpont/mysql/share/mysql/danish/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/portuguese/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mysql_fix_privilege_tables.sql
/usr/local/Calpont/mysql/share/mysql/italian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mi_test_all
/usr/local/Calpont/mysql/share/mysql/mysql_system_tables.sql
/usr/local/Calpont/mysql/share/mysql/my-innodb-heavy-4G.cnf
/usr/local/Calpont/mysql/share/mysql/norwegian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/fill_help_tables.sql
/usr/local/Calpont/mysql/share/mysql/spanish/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/ndb-config-2-node.ini
/usr/local/Calpont/mysql/share/mysql/slovak/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mysql_test_data_timezone.sql
/usr/local/Calpont/mysql/share/mysql/czech/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/english/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/hungarian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/mysqld_multi.server
/usr/local/Calpont/mysql/share/mysql/estonian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/german/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/errmsg.txt
/usr/local/Calpont/mysql/share/mysql/swedish/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/dutch/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/charsets/cp866.xml
/usr/local/Calpont/mysql/share/mysql/charsets/hebrew.xml
/usr/local/Calpont/mysql/share/mysql/charsets/latin2.xml
/usr/local/Calpont/mysql/share/mysql/charsets/armscii8.xml
/usr/local/Calpont/mysql/share/mysql/charsets/latin7.xml
/usr/local/Calpont/mysql/share/mysql/charsets/geostd8.xml
/usr/local/Calpont/mysql/share/mysql/charsets/latin5.xml
/usr/local/Calpont/mysql/share/mysql/charsets/swe7.xml
/usr/local/Calpont/mysql/share/mysql/charsets/keybcs2.xml
/usr/local/Calpont/mysql/share/mysql/charsets/cp1257.xml
/usr/local/Calpont/mysql/share/mysql/charsets/macroman.xml
/usr/local/Calpont/mysql/share/mysql/charsets/cp1251.xml
/usr/local/Calpont/mysql/share/mysql/charsets/cp1256.xml
/usr/local/Calpont/mysql/share/mysql/charsets/macce.xml
/usr/local/Calpont/mysql/share/mysql/charsets/dec8.xml
/usr/local/Calpont/mysql/share/mysql/charsets/latin1.xml
/usr/local/Calpont/mysql/share/mysql/charsets/greek.xml
/usr/local/Calpont/mysql/share/mysql/charsets/cp850.xml
/usr/local/Calpont/mysql/share/mysql/charsets/hp8.xml
/usr/local/Calpont/mysql/share/mysql/charsets/cp852.xml
/usr/local/Calpont/mysql/share/mysql/charsets/koi8r.xml
/usr/local/Calpont/mysql/share/mysql/charsets/README
/usr/local/Calpont/mysql/share/mysql/charsets/cp1250.xml
/usr/local/Calpont/mysql/share/mysql/charsets/koi8u.xml
/usr/local/Calpont/mysql/share/mysql/charsets/Index.xml
/usr/local/Calpont/mysql/share/mysql/charsets/ascii.xml
/usr/local/Calpont/mysql/share/mysql/config.medium.ini
/usr/local/Calpont/mysql/share/mysql/my-huge.cnf
/usr/local/Calpont/mysql/share/mysql/polish/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/my-medium.cnf
/usr/local/Calpont/mysql/share/mysql/my-large.cnf
/usr/local/Calpont/mysql/share/mysql/config.huge.ini
/usr/local/Calpont/mysql/share/mysql/ukrainian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/serbian/errmsg.sys
/usr/local/Calpont/mysql/share/mysql/my-small.cnf
/usr/local/Calpont/mysql/share/mysql/japanese/errmsg.sys
/usr/local/Calpont/mysql/mysql-Calpont
/usr/local/Calpont/mysql/install_calpont_mysql.sh
/usr/local/Calpont/mysql/syscatalog_mysql.sql
/usr/local/Calpont/mysql/dumpcat_mysql.sql
/usr/local/Calpont/mysql/dumpcat.pl

%config /usr/local/Calpont/mysql/my.cnf

# Scriptlets
# for an install, pre & post run with $1 set to 1
# for an erase, preun & postun run with $1 set to 0
# for an upgrade, pre & post run first, with $1 set to 2 then the _old_ preun & postun run with $1 set to 1

%post
rpmmode=install
if  [ "$1" -eq "$1" 2> /dev/null ]; then
    if [ $1 -ne 1 ]; then
		rpmmode=upgrade
	fi
fi

prefix=/usr/local

#test -f /usr/local/Calpont/mysql/my.cnf && \
#	test -x /usr/local/Calpont/bin/post-mysqld-install && \
#		/usr/local/Calpont/bin/post-mysqld-install --prefix=$prefix --rpmmode=$rpmmode
test -x /usr/local/Calpont/bin/post-install && /usr/local/Calpont/bin/post-install --prefix=$prefix --rpmmode=$rpmmode

echo "Calpont RPM install completed"

%post mysql
rpmmode=install
if  [ "$1" -eq "$1" 2> /dev/null ]; then
    if [ $1 -ne 1 ]; then
		rpmmode=upgrade
	fi
fi

prefix=/usr/local

#test -x /usr/local/Calpont/bin/post-mysql-install && /usr/local/Calpont/bin/post-mysql-install --prefix=$prefix #--rpmmode=$rpmmode

echo "Calpont RPM install completed"

%post mysqld
rpmmode=install
if  [ "$1" -eq "$1" 2> /dev/null ]; then
    if [ $1 -ne 1 ]; then
		rpmmode=upgrade
	fi
fi

prefix=/usr/local

#test -x /usr/local/Calpont/bin/post-mysqld-install && /usr/local/Calpont/bin/post-mysqld-install --prefix=$prefix #--rpmmode=$rpmmode

echo "Calpont RPM install completed"

%preun
rpmmode=upgrade
if  [ "$1" -eq "$1" 2> /dev/null ]; then
    if [ $1 -ne 1 ]; then
		rpmmode=erase
	fi
else
	rpmmode=erase
fi

if [ $rpmmode = erase ]; then
	test -x /usr/local/Calpont/bin/pre-uninstall && /usr/local/Calpont/bin/pre-uninstall
	rm -f /etc/init.d/infinidb
fi

exit 0

%preun mysqld
rpmmode=upgrade
if  [ "$1" -eq "$1" 2> /dev/null ]; then
    if [ $1 -ne 1 ]; then
		rpmmode=erase
	fi
else
	rpmmode=erase
fi

if [ $rpmmode = erase ]; then
	/etc/init.d/mysql-Calpont stop > /dev/null 2>&1
        if [ -x /sbin/chkconfig ]; then
               /sbin/chkconfig mysql-Calpont off > /dev/null 2>&1
               /sbin/chkconfig --del mysql-Calpont > /dev/null 2>&1
        elif [ -x /usr/sbin/update-rc.d ]; then
               /usr/sbin/update-rc.d -f mysql-Calpont remove > /dev/null 2>&1
        fi	
	rm -f /etc/init.d/mysql-Calpont
fi

exit 0

